/*!
 * layer-control v0.0.1 (https://github.com/dkiyatkin/controller)
 * Copyright (c) 2014 Dmitriy Kiyatkin <info@dkiyatkin.com> (http://dkiyatkin.com)
 * Licensed under MIT (https://github.com/dkiyatkin/controller/raw/master/LICENSE)
 */
var Compile,Layer,Loader,Logger,Module,Promise,Selector,State,mixOf,moduleKeywords,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1},__slice=[].slice;moduleKeywords=["extended","included"],Module=function(_super){function Module(){return Module.__super__.constructor.apply(this,arguments)}return __extends(Module,_super),Module.extend=function(obj){var key,value,_ref;for(key in obj)value=obj[key],__indexOf.call(moduleKeywords,key)<0&&(this[key]=value);return null!=(_ref=obj.extended)&&_ref.apply(this),this},Module.include=function(obj){var key,value,_ref;for(key in obj)value=obj[key],__indexOf.call(moduleKeywords,key)<0&&(this.prototype[key]=value);return null!=(_ref=obj.included)&&_ref.apply(this),this},Module.prototype.empty=function(cb){return cb?cb():void 0},Module}(EventEmitter),mixOf=function(){var Mixed,base,method,mixin,mixins,name,_i,_ref;for(base=arguments[0],mixins=2<=arguments.length?__slice.call(arguments,1):[],Mixed=function(_super){function Mixed(){return Mixed.__super__.constructor.apply(this,arguments)}return __extends(Mixed,_super),Mixed}(base),_i=mixins.length-1;_i>=0;_i+=-1){mixin=mixins[_i],_ref=mixin.prototype;for(name in _ref)method=_ref[name],Mixed.prototype[name]=method}return Mixed},Logger=function(_super){function Logger(options){null==options&&(options={}),this.log={history:"",logger:options.logger||"WARNING",quiet:options.quiet||!1,debug:function(){var msg;return msg=1<=arguments.length?__slice.call(arguments,0):[],_log(msg,3,this)},info:function(){var msg;return msg=1<=arguments.length?__slice.call(arguments,0):[],_log(msg,2,this)},warn:function(){var msg;return msg=1<=arguments.length?__slice.call(arguments,0):[],_log(msg,1,this)},error:function(){var msg;return msg=1<=arguments.length?__slice.call(arguments,0):[],_log(msg,0,this)}}}var loggers,_log;return __extends(Logger,_super),loggers=["ERROR","WARNING","INFO","DEBUG"],_log=function(msg,log_level,log){return loggers.indexOf(log.logger)>=log_level?(msg="["+(new Date).toGMTString()+"] "+loggers[log_level]+" "+msg.join(" "),log.quiet||(3===log_level&&console.log(msg),2===log_level&&console.info(msg),1===log_level&&console.warn(msg),0===log_level&&console.error(msg)),log.history+="\n"+msg,msg):void 0},Logger}(Module),"undefined"==typeof window||null===window?(Logger=require("./logger.coffee"),Promise=require("es6-promise").Promise):(Logger=window.Logger,Promise=window.Promise),Loader=function(_super){function Loader(options){var _busy;null==options&&(options={}),Loader.__super__.constructor.apply(this,arguments),this.load=function(_this){return function(path,options,cb){return null==options&&(options={}),cb||(cb=options),null==_this.load.cache.text[path]?_this.load.loading[path]?(_this.log.debug("multiply loading: "+path),_this.once("loaded: "+path,function(err){return cb(err,_this.load.cache.text[path])})):(_this.load[path]=!0,_this.load.load(path,options,function(err,ans){return _this.load.cache.text[path]=ans,err&&_this.log.error("error load "+path),_this.load.loading[path]=!1,_this.emit("loaded: "+path,err),cb(err,_this.load.cache.text[path])})):cb(null,_this.load.cache.text[path])}}(this),this.load.cache={css:{},data:{},text:{}},this.load.loading={},this.load.load=options.load||_load,this.load.json=function(_this){return function(path,options,cb){return null==options&&(options={}),cb||(cb=options),options.type="json",null==_this.load.cache.data[path]?_this.load(path,options,function(err,text){var e;try{_this.load.cache.data[path]=JSON.parse(text)}catch(_error){e=_error,_this.log.error("wrong json data "+path)}return cb(err,_this.load.cache.data[path])}):cb(null,_this.load.cache.data[path])}}(this),this.load.js=function(_this){return function(path,options,cb){return null==options&&(options={}),cb||(cb=options),/^http(s){0,1}:\/\//.test(path)||/^\/\//.test(path)?(setXDR(path,_this),cb(null)):(options.type="text",_this.load(path,function(err,options,ans){var e;if(err)return cb(err);try{return globalEval(ans,this),cb(null)}catch(_error){return e=_error,this.log.error("wrong js "+path),cb(e)}}))}}(this),_busy=!1,this.load.script=function(_this){return function(node){var e;if(_busy)return void setTimeout(function(){return this.load.script(node)},1);if(_busy=!0,node.src)return _this.load.js(node.src,function(){return _busy=!1});try{globalEval(node.innerHTML,_this)}catch(_error){e=_error,_this.log.error("Ошибка в скрипте.")}return _busy=!1}}(this),this.load.css=function(_this){return function(code){var head,style;if(!_this.load.cache.css[code])return _this.load.cache.css[code]=!0,style=_this.document.createElement("style"),style.type="text/css",style.styleSheet?style.styleSheet.cssText=code:style.appendChild(_this.document.createTextNode(code)),head=_this.$("head"),head.insertBefore(style,head.lastChild)}}(this),this.load.clearCache=function(_this){return function(clean){return null==clean?(_this.load.cache.data={},_this.load.cache.text={}):clean.constructor===RegExp?(_clearRegCache(clean,_this.load.cache.data),_clearRegCache(clean,_this.load.cache.text)):(delete _this.load.cache.data[clean],delete _this.load.cache.text[clean])}}(this)}var createRequestObject,globalEval,setXDR,_clearRegCache,_load;return __extends(Loader,_super),createRequestObject=function(){return"undefined"==typeof XMLHttpRequest||null===XMLHttpRequest?function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(_error){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(_error){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(_error){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(_error){}throw new Error("This browser does not support XMLHttpRequest.")}:new XMLHttpRequest},globalEval=function(data,controller){var head,script;return head=controller.$("head"),script=controller.document.createElement("script"),script.type="text/javascript",script.text=data,head.insertBefore(script,head.firstChild),head.removeChild(script)},setXDR=function(path,controller){var head,script;return script=controller.document.createElement("script"),script.type="text/javascript",head=controller.$("head"),script.src=path,head.insertBefore(script,head.firstChild),head.removeChild(script)},_clearRegCache=function(clean,obj){var key,_results;_results=[];for(key in obj)__hasProp.call(obj,key)&&_results.push(clean.test(key)?delete obj[key]:void 0);return _results},_load=function(url,options,cb){return new Promise(function(resolve,reject){var e,params,req,timeout;try{if(timeout=!1,req=new createRequestObject,options.timestamp&&(url=-1===url.indexOf("?")?url+"?timestamp="+(new Date).getTime():url+"&timestamp="+(new Date).getTime()),req.open(options.method||"GET",url,null!=options.async?options.async:!0),params=null,"POST"===options.method&&(req.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8"),params=options.params),"json"===options.type?(req.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8"),req.setRequestHeader("Accept","application/json, text/javascript")):req.setRequestHeader("Content-Type","text/plain; charset=utf-8"),req.setRequestHeader("If-Modified-Since","Sat, 1 Jan 2005 00:00:00 GMT"),req.setRequestHeader("X-Requested-With","XMLHttpRequest"),req.onreadystatechange=function(){var error;if(4===req.readyState&&!timeout)if(200===req.status){if(resolve(req.responseText),cb)return cb(null,req.responseText)}else if(error=Error(req.statusText),reject(error),cb)return cb(error)},req.send(params),options.timeout)return setTimeout(function(){var error;return timeout=!0,req.abort(),error=Error("timeout"),reject(error),cb?cb(error):void 0},options.timeout)}catch(_error){if(e=_error,reject(e),cb)return cb(e)}})},Loader}(Logger),Selector=function(_super){function Selector(options){null==options&&(options={}),Selector.__super__.constructor.apply(this,arguments),this.$=options.$||selector}var find,html,selector;return __extends(Selector,_super),html=function(htmlString){var i;if(htmlString){if(null!=this.length)for(i=this.length;--i>=0;)this[i].innerHTML=htmlString;else this.innerHTML=htmlString;return this}return null!=this.length?this[this.length-1].innerHTML:this.innerHTML},find=function(query){var i,ii,node,node_child;if(node_child=[],node_child.find=find,node_child.html=html,this.length>1)for(i=this.length;--i>=0;)for(node=this[i].querySelectorAll(query),ii=node.length;--ii>=0;)node[ii].find=find,node[ii].html=html,node_child.push(node[ii]);else 1===this.length&&(node_child=this[0].querySelectorAll(query),node_child.find=find,node_child.html=html);return node_child},selector=function(query){var node_parent;return node_parent=window.document.querySelectorAll(query),node_parent.find=find,node_parent.html=html,node_parent},Selector}(Loader),Compile=function(_super){function Compile(options){this.options=null!=options?options:{},Compile.__super__.constructor.apply(this,arguments),this.log.debug("init")}return __extends(Compile,_super),Compile.prototype.externalLayer=function(layer,cb){return layer.ext&&!layer.extData?(this.log.debug("new external",layer.ext),this.load(layer.ext,function(err,data){var e,eList,i,layers,len,num,param,prop,_ref,_ref1;if(layer.extData={},err)return cb();try{try{layer.extData=eval_("("+data+")")}catch(_error){e=_error,layer.extData=eval_(data)}if(layers=this.layers,this.compile(layer.extData),layer.extData=this.layers,this.layers=layers,layer.config&&layer.extData[0].config){_ref=layer.extData[0].config;for(param in _ref)__hasProp.call(_ref,param)&&(layer.config[param]||(layer.config[param]=layer.extData[0].config[param]))}_ref1=layer.extData[0];for(prop in _ref1)__hasProp.call(_ref1,prop)&&(layer[prop]||(layer[prop]=layer.extData[0][prop]));for(eList=["onload","oncheck","onshow"],i=0,len=eList.length;len>i;)!function(prop){var value;return value=layer["_"+prop],value?layer[prop]=function(cb){try{return value.call(layer,cb)}catch(_error){return e=_error,this.log.error(prop+" "+e),cb()}}:void 0}(eList[i]),i++;if(len=layer.extData.length)for(num=this.layers.indexOf(layer),i=1;len>i;)num++,this.layers.splice(num,0,layer.extData[i]),i++;return cb()}catch(_error){return e=_error,this.log.error("wrong ext",layer.ext),cb()}})):cb()},Compile.prototype.compile=function(index,parentLayer){var i,_i,_ref,_results;if(null==index&&(index=this.options.index),parentLayer||(this.layers=[],parentLayer=this.layers,parentLayer.show=!0,this.labels={}),parentLayer.childLayers=[],index.splice){for(_results=[],i=_i=0,_ref=index.length;_ref>=0?_ref>_i:_i>_ref;i=_ref>=0?++_i:--_i)_results.push(this.compileLayer(index[i],parentLayer));return _results}return this.compileLayer(index,parentLayer)},Compile.prototype.compileLayer=function(layer,parentLayer){var childLayer,i,layerLabels,newParentLayer,param,_i,_ref,_ref1,_ref2;if(newParentLayer={query:layer.query,state:layer.state||parentLayer.state||"/",css:layer.css,json:layer.json,jsontpl:layer.jsontpl,tpl:layer.tpl,tpltpl:layer.tpltpl,label:layer.label,ext:layer.ext,config:layer.config||{},data:layer.data,tplString:layer.tplString,htmlString:layer.htmlString,childLayers:[],childQueries:{},childStates:{},oncheck:layer.oncheck||this.empty,onload:layer.onload||this.empty,onshow:layer.onshow||this.empty,parentLayer:parentLayer,node:null,regState:null,status:"queue",id:0},this.layers.push(newParentLayer),newParentLayer.id=layer.id||this.layers.length,layer.label)for(layerLabels=layer.label.split(" "),i=_i=0,_ref=layerLabels.length;_ref>=0?_ref>_i:_i>_ref;i=_ref>=0?++_i:--_i)layerLabels[i]&&(this.labels[layerLabels[i]]||(this.labels[layerLabels[i]]=[]),this.labels[layerLabels[i]].push(newParentLayer));if(parentLayer.childLayers.push(newParentLayer),layer.childLayers&&this.compile(layer.childLayers,newParentLayer),layer.childQueries){_ref1=layer.childQueries;for(param in _ref1)__hasProp.call(_ref1,param)&&(childLayer=_ref1[param],childLayer.query=param,newParentLayer.childQueries[param]=this.compile(childLayer,newParentLayer))}if(layer.childStates){_ref2=layer.childStates;for(param in _ref2)__hasProp.call(_ref2,param)&&(childLayer=_ref2[param],childLayer.state="^"===param[0]||"$"===param.slice(-1)?param:newParentLayer.state+param+"/",newParentLayer.childStates[param]=this.compile(childLayer,newParentLayer))}return this.emit("compile",layer,parentLayer),"^"!==newParentLayer.state[0]&&"$"!==newParentLayer.state.slice(-1)&&(newParentLayer.state="^"+newParentLayer.state+".*$"),newParentLayer},Compile}(Selector),State=function(_super){function State(options){null==options&&(options={}),State.__super__.constructor.apply(this,arguments),this.tplRender=options.tplRender,this.state=function(state,cb){var listeners;return null==state&&(state="/"),null==cb&&(cb=this.empty),cb===this.empty&&"[object Function]"===Object.prototype.toString.call(state)&&(cb=state,state="/"),this.state.circle&&this.state.circle.run?(this.log.debug("state queue"),this.state.circle.interrupt=!0,this.once("queue",function(_this){return function(){return _this.state(state,cb)}}(this)),listeners=_getListeners("queue",this),listeners.splice(0,listeners.length-this.state.circle.queue)):(this.layers||this.compile(),this.layers.length||this.log.info("empty layers"),this.emit("start",state,cb))},this.state.runs=0,this.on("start",function(state,cb){var i,listeners;if(listeners=_getListeners("queue",this)||[],this.log.debug("first circle, queue: "+listeners.length),this.state.runs++,this.state.circle={interrupt:!1,count:0,queries:{},loading:0,state:state?state+"":void 0,limit:options.limit?options.limit:100,queue:options.queue?options.queue:1,length:this.layers.length,cb:cb?cb:null,timeout:options.timeout?options.timeout:1e4,time:Date.now(),run:!0},this.state.circle.state){for(i=this.state.circle.length;--i>=0;)this.layers[i].status="queue",this.layers[i].regState=this.state.circle.state.match(new RegExp(this.layers[i].state,"im")),this.layers[i].jsontpl&&(this.layers[i].json=this.tplRender(this.layers[i].jsontpl,this.layers[i])),this.layers[i].tpltpl&&(this.layers[i].tpl=this.tplRender(this.layers[i].tpltpl,this.layers[i])),delete this.layers[i].node;return this.emit("circle")}return this.log.warn("no set circle.state"),this.emit("end")}),this.on("circle",function(){var run;return run=this.state.runs,setTimeout(function(_this){return function(){var i,listeners,restrictions;if(_this.state.circle.run&&run===_this.state.runs){for(i=_this.state.circle.length;--i>=0;)"queue"===_this.layers[i].status&&(_this.state.circle.num=i,_this.emit("layer",_this.layers[i],i));if(restrictions=updateRestrictions(_this.state.circle,_getListeners("circle",_this)),restrictions&&_this.log.warn(restrictions),listeners=_getListeners("circle",_this),listeners.length>1)return _this.emit("circle");if(!_this.state.circle.loading)return _this.emit("end")}}}(this),0)}),this.on("end",function(){return this.log.debug("end, circle.count: "+this.state.circle.count+", number of runs: "+this.state.runs),this.state.circle.run=!1,this.state.circle.cb(),this.emit("queue")})}var updateRestrictions,_getListeners;return __extends(State,_super),updateRestrictions=function(circle,listeners){var restrictions;return restrictions="",++circle.count>=circle.limit&&(restrictions+="\n"+circle.limit+" limit"),circle.timeout<Date.now()-circle.time&&(restrictions+="\n"+circle.timeout+" timeout"),restrictions.trim(),restrictions&&(listeners.splice(0,listeners.length),circle.loading=0),restrictions},_getListeners=function(event,eventObject){var listeners;return eventObject.listeners?listeners=eventObject.listeners(event):eventObject._events&&(listeners=eventObject._events[event]),listeners},State}(Compile),Layer=function(_super){function Layer(options){null==options&&(options={}),Layer.__super__.constructor.apply(this,arguments),this.getLayerTemplate=getLayerTemplate,this.getLayerData=getLayerData,this.loadLayer=loadLayer,this.displaceLayers=displaceLayers,this.checkLayer=checkLayer,this.enableLayer=enableLayer,this.disableLayer=disableLayer,this.on("layer",function(layer){return layer.check=this.checkLayer(layer),layer.check===!0?this.enableLayer(layer):layer.show?this.disableLayer(layer):void 0})}var checkLayer,disableLayer,displaceLayers,enableLayer,getLayerData,getLayerTemplate,loadLayer,_busyQueries,_stateOk;return __extends(Layer,_super),_busyQueries=function(node,queries){var i;for(i=queries.length;--i>=0;)if(node.find(queries[queries[i]]).length)return!0;return!1},_stateOk=function(regState,state){return regState&&regState[0]&&state===regState[0]?!0:!1},displaceLayers=function(layer){var i,_results;for(layer.status="displace layers",i=this.state.circle.length,_results=[];--i>=0;)this.layers[i].show?layer.query===this.layers[i].query||_results.push(this.$(layer.query)===this.$(this.layers[i].query)?this.disableLayer(this.layers[i]):this.$(layer.query).find(this.layers[i].query).length?this.disableLayer(this.layers[i]):void 0):_results.push(void 0);return _results},getLayerTemplate=function(layer,cb){return null==layer.tplString&&layer.tpl?this.load(layer.tpl,function(){return function(err,txt){return err||(layer.tplString=txt),cb()}}(this)):cb()},getLayerData=function(layer,cb){return null==layer.data&&layer.json?this.load.json(layer.json,function(){return function(err,data){return err||(layer.data=data),cb()}}(this)):cb()},loadLayer=function(layer,cb){var counter;return counter=2,layer.htmlString?cb():layer.tpl||layer.tplString?(this.getLayerTemplate(layer,function(_this){return function(){return 0===--counter?layer.onload(function(){return layer.htmlString=_this.tplRender(layer.tplString,layer),cb()}):void 0}}(this)),this.getLayerData(layer,function(_this){return function(){return 0===--counter?layer.onload(function(){return layer.htmlString=_this.tplRender(layer.tplString,layer),cb()}):void 0}}(this))):cb(1)},checkLayer=function(layer){return layer.parentLayer.show?this.state.circle.queries[layer.query]?"query already exists "+layer.query:(layer.node||(layer.node=this.$(layer.query)),layer.node.length?!layer.show&&_busyQueries(layer.node,Object.keys(this.state.circle.queries))?"busy tags":_stateOk(layer.regState,this.state.circle.state)?!0:"state mismatch":"not inserted"):"no parent"},enableLayer=function(layer){return layer.status="enable",this.state.circle.queries[layer.query]=layer,layer.show||this.displaceLayers(layer),this.once("circle",function(_this){return function(){return _this.state.circle.interrupt?_this.log.debug("check interrupt 1"):(_this.state.circle.loading++,_this.externalLayer(layer,function(){return layer.oncheck(function(){return layer.nowState=_this.state.circle.state,layer.status="insert",layer.show?_this.state.circle.loading--:_this.loadLayer(layer,function(err){return err?(_this.log.error("layer can not be inserted",layer.id),layer.status="wrong insert",_this.state.circle.loading--):_this.state.circle.interrupt?(_this.log.debug("check interrupt 2"),_this.state.circle.loading--):(_this.$(layer.query).html(layer.htmlString),layer.lastState=_this.state.circle.state,layer.show=!0,layer.onshow(function(){return _this.state.circle.loading--}))})})}))}}(this))},disableLayer=function(layer){var i;for(i=layer.childLayers.length;--i>=0;)this.disableLayer(layer.childLayers[i]);return this.$(layer.query).html(""),layer.show=!1,layer.status="disable",delete layer.node},Layer}(State);